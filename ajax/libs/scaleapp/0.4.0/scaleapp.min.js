/*!
scaleapp - v0.4.0 - 2013-08-01
This program is distributed under the terms of the MIT license.
Copyright (c) 2011-2013 Markus Kohlhase <mail@markus-kohlhase.de>
*/
!function(){var a,b,c,d,e,f,g,h,i,j,k,l=[].slice;null==String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),g=function(a){var b,c,d,e,f;if(null==a&&(a=function(){}),c=a.toString().match(/function[^(]*\(([^)]*)\)/),null==c||c.length<2)return[];for(c=c[1],c=c.split(/\s*,\s*/),f=[],d=0,e=c.length;e>d;d++)b=c[d],""!==b.trim()&&f.push(b);return f},h=function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a&&(a=[]),null==b&&(b=function(){}),d=a.length,g=[],0===d)return b(null,g);for(e=[],k=[],f=i=0,j=a.length;j>i;f=++i)h=a[f],k.push(function(a,f){var h,i;i=function(){var a,h,i;if(h=arguments[0],i=2<=arguments.length?l.call(arguments,1):[],h){if(e[f]=h,!c)return b(e,g)}else g[f]=i.length<2?i[0]:i;return 0===--d?function(){var b,c,d;for(d=[],b=0,c=e.length;c>b;b++)a=e[b],null!=a&&d.push(a);return d}().length>0?b(e,g):b(null,g):void 0};try{return a(i)}catch(j){return h=j,i(h)}}(h,f));return k},i=function(a,b,c){var d,e,f,g,h;return null==a&&(a=[]),null==b&&(b=function(){}),f=-1,d=a.length,h=[],0===d?b(null,h):(e=[],g=function(){var i,j,k;if(j=arguments[0],k=2<=arguments.length?l.call(arguments,1):[],j){if(e[f]=j,!c)return b(e,h)}else h[f]=k.length<2?k[0]:k;if(++f===d)return function(){var a,b,c;for(c=[],a=0,b=e.length;b>a;a++)i=e[a],null!=i&&c.push(i);return c}().length>0?b(e,h):b(null,h);try{return a[f](g)}catch(m){return i=m,g(i)}},g())},j=function(a,b){var c,d;return c=-1,0===a.length?b():(d=function(){var e,f;return e=arguments[0],f=2<=arguments.length?l.call(arguments,1):[],null!=e?b(e):++c===a.length?b.apply(null,[null].concat(l.call(f))):a[c].apply(a,l.call(f).concat([d]))},d())},f=function(a,b,c,d){var e,f;return null==a&&(a=[]),f=function(){var c,d,f;for(f=[],c=0,d=a.length;d>c;c++)e=a[c],f.push(function(a){return function(c){return b(a,c)}}(e));return f}(),k.runParallel(f,c,d)},k={doForAll:f,runParallel:h,runSeries:i,runWaterfall:j,getArgumentNames:g,hasArgument:function(a,b){return null==b&&(b=1),k.getArgumentNames(a).length>=b}},b=function(){function a(a,b){this.cascadeChannels=null!=b?b:!1,this.channels={},a instanceof Object?this.installTo(a):a===!0&&(this.cascadeChannels=!0)}return a.prototype.on=function(b,c,d){var e,f,g,h,i,j,k,l,m,n;if(null==d&&(d=this),null==(j=this.channels)[b]&&(j[b]=[]),h=this,b instanceof Array){for(m=[],k=0,l=b.length;l>k;k++)e=b[k],m.push(this.on(e,c,d));return m}if("object"==typeof b){n=[];for(f in b)i=b[f],n.push(this.on(f,i,c));return n}return"function"!=typeof c?!1:"string"!=typeof b?!1:(g={context:d,callback:c},{attach:function(){return h.channels[b].push(g),this},detach:function(){return a._rm(h,b,g.callback),this}}.attach())},a.prototype.off=function(b,c){var d;switch(typeof b){case"string":"function"==typeof c&&a._rm(this,b,c),"undefined"==typeof c&&a._rm(this,b);break;case"function":for(d in this.channels)a._rm(this,d,b);break;case"undefined":for(d in this.channels)a._rm(this,d);break;case"object":for(d in this.channels)a._rm(this,d,null,b)}return this},a.prototype.emit=function(a,b,c){var d,e,f,g;return null==c&&(c=function(){}),"function"==typeof b&&(c=b,b=void 0),"string"!=typeof a?!1:(f=this.channels[a]||[],g=function(){var c,d,g;for(g=[],c=0,d=f.length;d>c;c++)e=f[c],g.push(function(c){return function(d){var e;try{return k.hasArgument(c.callback,3)?c.callback.apply(c.context,[b,a,d]):d(null,c.callback.apply(c.context,[b,a]))}catch(f){return e=f,d(e)}}}(e));return g}(),k.runSeries(g,function(a){var b,d;return a&&(b=new Error(function(){var b,c,e;for(e=[],b=0,c=a.length;c>b;b++)d=a[b],null!=d&&e.push(d.message);return e}().join("; "))),c(b)},!0),this.cascadeChannels&&(d=a.split("/")).length>1&&this.emit(d.slice(0,-1).join("/"),b,c),this)},a.prototype.installTo=function(a){var b,c;if("object"==typeof a)for(b in this)c=this[b],null==a[b]&&(a[b]=c);return this},a._rm=function(a,b,c,d){var e;if(null!=a.channels[b])return a.channels[b]=function(){var f,g,h,i;for(h=a.channels[b],i=[],f=0,g=h.length;g>f;f++)e=h[f],(null!=c?e.callback!==c:null!=d?e.context!==d:e.context!==a)&&i.push(e);return i}()},a}(),c=function(){function a(a,b,c){this.core=a,this.instanceId=b,this.options=null!=c?c:{},this.core._mediator.installTo(this)}return a}(),e=function(a,b,c){return typeof b!==a?""+c+" has to be a "+a:void 0},a=function(){function a(a){null==a&&(a=c),this._modules={},this._plugins=[],this._instances={},this._sandboxes={},this._mediator=new b,this.Sandbox=a,this.Mediator=b}return a.prototype.log={error:function(){},log:function(){},info:function(){},warn:function(){},enable:function(){}},a.prototype.register=function(a,b,c){var d;return null==c&&(c={}),(d=e("string",a,"module ID")||e("function",b,"creator")||e("object",c,"option parameter"))?(this.log.error("could not register module '"+a+"': "+d),this):null!=this._modules[a]?(this.log.warn("module "+a+" was already registered"),this):(this._modules[a]={creator:b,options:c,id:a},this)},a.prototype.start=function(a,b,c){var d,f,g,h,i,j=this;return null==b&&(b={}),null==c&&(c=function(){}),0===arguments.length?this._startAll():a instanceof Array?this._startAll(a,b):"function"==typeof a?this._startAll(null,a):("function"==typeof b&&(c=b,b={}),f=function(a){return j.log.error(a),c(new Error("could not start module: "+a.message)),j},(d=e("string",a,"module ID")||e("object",b,"second parameter")||(null==this._modules[a]?"module doesn't exist":void 0))?f(d):(g=b.instanceId||a,(null!=(i=this._instances[g])?i.running:void 0)===!0?f(new Error("module was already started")):(h=function(a,b){if(a)return j.log.error(a),c(a);try{return k.hasArgument(b.init,2)?b.init(b.options,function(a){return a||(b.running=!0),c(a)}):(b.init(b.options),b.running=!0,c(null))}catch(e){if(d=e)return f(d)}},this.boot(function(){return j._createInstance(a,b.instanceId,b.options,h)}))))},a.prototype._createInstance=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n=this;if(null==b&&(b=a),g=this._modules[a],null!=this._instances[b])return d(this._instances[b]);for(e={},m=[g.options,c],k=0,l=m.length;l>k;k++)if(h=m[k])for(f in h)j=h[f],null==e[f]&&(e[f]=j);return i=new this.Sandbox(this,b,e),i.moduleId=a,this._runSandboxPlugins("init",i,function(){var a;return a=new g.creator(i),"function"!=typeof a.init?d(new Error("module has no 'init' method")):(a.options=e,a.id=b,n._instances[b]=a,n._sandboxes[b]=i,d(null,a))})},a.prototype._runSandboxPlugins=function(a,b,c){var d,e;return e=function(){var c,e,f,g,h;for(f=this._plugins,h=[],c=0,e=f.length;e>c;c++)d=f[c],"function"==typeof(null!=(g=d.plugin)?g[a]:void 0)&&h.push(function(c){var d;return d=c.plugin[a],function(a){return k.hasArgument(d,3)?d(b,c.options,a):(d(b,c.options),a())}}(d));return h}.call(this),k.runSeries(e,c,!0)},a.prototype._startAll=function(a,b){var c,d,e,f=this;return null==a&&(a=function(){var a;a=[];for(d in this._modules)a.push(d);return a}.call(this)),e=function(a,b){return f.start(a,f._modules[a].options,b)},c=function(c){var d,e,f,g;return(null!=c?c.length:void 0)>0&&(f=function(){var b,d,f;for(f=[],e=b=0,d=c.length;d>b;e=++b)g=c[e],null!=g&&f.push("'"+a[e]+"'");return f}(),d=new Error("errors occoured in the following modules: "+f)),"function"==typeof b?b(d):void 0},k.doForAll(a,e,c,!0),this},a.prototype.stop=function(a,b){var c,d,e=this;return 0===arguments.length||"function"==typeof a?k.doForAll(function(){var a;a=[];for(d in this._instances)a.push(d);return a}.call(this),function(){return e.stop.apply(e,arguments)},a,!0):(c=this._instances[a])&&(delete this._instances[a],this._mediator.off(c),this._runSandboxPlugins("destroy",this._sandboxes[a],function(){return null==c.destroy&&(c.destroy=function(){}),k.hasArgument(c.destroy)?c.destroy(function(d){return d&&(this._instances[a]=c),"function"==typeof b?b(d):void 0}):(c.destroy(),"function"==typeof b?b(null):void 0)})),this},a.prototype.use=function(a,b){var c,d,e;if(a instanceof Array)for(d=0,e=a.length;e>d;d++)c=a[d],"function"==typeof c&&this.use(c),"object"==typeof c&&this.use(c.plugin,c.options);else{if("function"!=typeof a)return this;this._plugins.push({creator:a,options:b})}return this},a.prototype.boot=function(a){var b,c,d;return b=this,d=function(){var a,d,e,f;for(e=this._plugins,f=[],a=0,d=e.length;d>a;a++)c=e[a],c.booted!==!0&&f.push(function(a){return k.hasArgument(a.creator,3)?function(c){var d;return d=a.creator(b,a.options,function(b){return b||(a.booted=!0,a.plugin=d),c()})}:function(c){return a.plugin=a.creator(b,a.options),a.booted=!0,c()}}(c));return f}.call(this),k.runSeries(d,a,!0),this},a.prototype.on=function(){return this._mediator.on.apply(this._mediator,arguments)},a.prototype.off=function(){return this._mediator.off.apply(this._mediator,arguments)},a.prototype.emit=function(){return this._mediator.emit.apply(this._mediator,arguments)},a}(),d={VERSION:"0.4.0",util:k,Mediator:b,Sandbox:c,Core:a,plugins:{},modules:{}},null!=("undefined"!=typeof define&&null!==define?define.amd:void 0)?define(function(){return d}):"undefined"!=typeof window&&null!==window?null==window.scaleApp&&(window.scaleApp=d):null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)&&(module.exports=d)}.call(this);